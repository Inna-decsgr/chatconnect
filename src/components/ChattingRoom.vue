<template>
  <div id="app">
    <div>
      <ChatTopBar />
    </div>
    <div class="chat-container p-3" ref="chatContainer">
      <div v-for="(group, groupIndex) in messages" :key="groupIndex">
        <!-- ÎÇ†ÏßúÎ≥ÑÎ°ú ÌëúÏãú-->
        <p class="bg-gray-800 bg-opacity-5 text-center w-[160px] mx-auto my-3 text-xs py-[6px] rounded-xl text-gray-600">
          <i class="fa-regular fa-calendar"></i>
          {{group.date}} {{ group.day }}
        </p>
        <!--ÎÇ†ÏßúÎ≥ÑÎ°ú Î©îÏãúÏßÄ Î∞òÎ≥µ-->
        <div v-for="(minuteGroup, minuteIndex) in group.groupedMinutes" :key="minuteIndex" class="mb-2">
        <!--ÏâΩÍ≤å ÏÉùÍ∞ÅÌïòÎ©¥ receiver_id, ÏàòÏã†ÏûêÍ∞Ä 7Ïù¥Í≥† Î≥¥ÎÇ¥Îäî ÏÇ¨ÎûåÏù¥ 8Ïù¥ÎùºÍ≥† ÏπòÏûê. Í∑∏Îüº sender_idÏôÄ user.useridÎäî
        8Î°ú Í∞ôÏùÑÏàòÎ∞ñÏóê ÏóÜÏûñÏïÑ. ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÍ∞Ä Î©îÏãúÏßÄÎ•º Î≥¥ÎÇºÌÖåÎãàÍπå. Í∑ºÎç∞ Ïö∞Î¶¨Í∞Ä Ï±ÑÌåÖÎ∞©ÏùÑ ÎßåÎì§Îïå Í∞ôÏùÄ Î∞©ÏùÑ 
        Í≥µÏú†ÌïòÍ≤å ÎßåÎì§Ïñ¥ÎíÄÏúºÎãàÍπå 7Ïù¥ senderÍ∞Ä Îê†ÏàòÎèÑ receiverÍ∞Ä Îê†ÏàòÎèÑ ÏûàÍ≥† 8Ïù¥ senderÍ∞Ä Îê†ÏàòÎèÑ receiverÍ∞Ä Îê† ÏàòÎèÑ ÏûàÏûñÏïÑ Í∑∏Ïπò?
        Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Î≥¥Î©¥ÏÑú Ïù¥Ìï¥ÌïòÎ©¥ Îçî ÏûòÎê†Í±∞Ïïº. receiver_idÍ∞Ä useridÏôÄ Í∞ôÏùÄÍ≤ÉÎßå Îî∞Î°ú Î™®ÏïÑÏÑú ÏôºÏ™Ω Ï†ïÎ†¨ÌïòÍ≥†
        receiver_idÏôÄ useridÍ∞Ä Îã§Î•∏Í≤ÉÎßå Î™®ÏïÑÏÑú Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ÌïòÎäîÍ±∞Ïïº! Í∑∏ÎÉ• ÏïºÎß§Î°ú ÏÉùÍ∞ÅÌïòÏûêÎ©¥ ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Îêú
        ÏÇ¨Ïö©ÏûêÍ∞Ä senderÍ∞Ä ÎêòÏñ¥ÏÑú Ïò§Î•∏Ï™ΩÏóê Î≥¥Ïó¨ÏïºÌïòÎäîÍ±∞ÏûñÏïÑ. Í∑∏Îü¨ÎãàÍπå Î∞òÎåÄÎ°ú ÏÉùÍ∞ÅÌï¥ÏÑú receiver_idÏôÄ userid
        Í∞Ä Í∞ôÏùÄ Í≤ÉÎßå Í≥®ÎùºÏÑú ÏôºÏ™ΩÏ†ïÎ†¨ÌïòÎ©¥ v-elseÌñàÏùÑÎïå Î∞òÎåÄÏùò Í≤ΩÏö∞Í∞Ä Îã§ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ÎêòÎãàÍπå Í∑∏Îü∞Í±∞ÎùºÍ≥† ÏÉùÍ∞ÅÌï¥.
        ÎØ∏ÎûòÏùò ÎÇòÏïº...Í≥ºÍ±∞Ïùò ÎÇ¥Í∞Ä Î©çÏ≤≠Ìï¥ÏÑú ÎØ∏Ïïà ÌóàÌóàÌóà ÎÇ¥Í∞Ä Í≥†Ï≥§Ïñ¥! ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏôÄ sender_idÍ∞Ä 
        Í∞ôÏßÄ ÏïäÏúºÎ©¥ ÏàòÏã†ÏûêÎùºÎäî Í±∞ÎãàÍπå msg.receiver_id === user.useridÏóêÏÑú ÏïÑÎûòÏôÄ Í∞ôÏù¥ Î∞îÍøà!„Öé„Öé-->
          <!-- ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨Îêú Î©îÏãúÏßÄÎ•º ÌëúÏãú -->
          <div v-for="(msg, msgIndex) in minuteGroup" :key="msgIndex">
            <div class="message-wrapper" :class="msg.sender_id === user.userid ? 'sender-wrapper' : 'receiver-wrapper'">
              <div class="message-container">
                <div class="flex">
                  <!-- ‚úÖ Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÏóêÎßå ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÌëúÏãú -->
                  <img v-if="isFirstAfterReply(minuteGroup, msgIndex, minuteGroup) && msg.sender_id !== user.userid" :src="msg.receiver_profile_image ? `http://localhost:5000${msg.receiver_profile_image}` : '/images/ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ.png'" class="w-[40px] h-[40px] object-cover rounded-[16px]">
                  <div class="pl-3">
                  <!-- ‚úÖ Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÏóêÎßå ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÌëúÏãú -->
                    <p class="text-[12px] mb-[3px]" v-if="isFirstAfterReply(minuteGroup, msgIndex, minuteGroup) && msg.sender_id !== user.userid">
                      {{ msg.sender_name }}
                    </p>
                    <div class="flex">
            
                      <!-- ‚úÖ ÏàòÏã†Ïûê(receiver)Ïùº Í≤ΩÏö∞ -->
                      <div v-if="msg.sender_id !== user.userid" class="flex">
                        <div>
                          <p :class="['message', 'receiver', msgIndex === 0 ? 'has-tail' : '', !isFirstAfterReply(minuteGroup, msgIndex, minuteGroup) ? 'ml-[39px]' : '']">
                            {{ msg.text }}
                          </p>
                        </div>
                        <!-- ‚úÖ ÎßàÏßÄÎßâ Î©îÏãúÏßÄÏùº Í≤ΩÏö∞ ÏãúÍ∞Ñ ÌëúÏãú -->
                        <p v-if="isLastMessageInSenderGroup(minuteGroup, msgIndex, minuteGroup)" class="time">
                          {{ msg.created_at }}
                        </p>
                      </div>

                      <!-- ‚úÖ Î∞úÏã†Ïûê(sender)Ïùº Í≤ΩÏö∞ -->
                      <div v-if="msg.sender_id === user.userid" class="flex items-center">
                        <div class="info-wrapper" :class="{'abc' : isLastMessageInSenderGroup(minuteGroup, msgIndex, minuteGroup) && !msg.is_read }">
                          <p v-if=" !msg.is_read && 
                            !readindicator[msg.message_id] &&
                            !isrealtime" 
                            class="unread-indicator"
                            :class="msgIndex !== minuteGroup.length - 1 ? 'mt-[14px]' : 'mt-[2px]'">1</p>
                          <!-- ‚úÖ ÎßàÏßÄÎßâ Î©îÏãúÏßÄÏóêÎßå ÏãúÍ∞Ñ ÌëúÏãú -->
                          <p v-if="isLastMessageInSenderGroup(minuteGroup, msgIndex, minuteGroup)" class="time">
                            {{ msg.created_at }}
                          </p>
                        </div>
                        <div>
                          <p :class="['message', 'sender', msgIndex === 0 ? 'has-tail' : '']">
                            {{ msg.text }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex">
      <input 
        type="text" 
        class="basis-5/6 text-xs p-3 outline-none" 
        v-model="newMessage" 
        placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•" 
        @keyup.enter="sendmessage"
        @input="newMessage = $event.target.value"
      >
      <!--@input Ïù¥Î≤§Ìä∏Îäî ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†• ÌïÑÎìúÏóê Í∞íÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò Î≥ÄÍ≤ΩÌï† ÎïåÎßàÎã§ Ìä∏Î¶¨Í±∞Îê®. 
        ÏûÖÎ†•Ìïú Í∞íÏùÑ Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í∞êÏßÄÌïòÎ©¥ÏÑú Ï∂îÍ∞ÄÎ°ú Í≥µÎ∞± Ï†úÍ±∞ ÏûëÏóÖÏùÑ Ï≤òÎ¶¨ÌïòÍ∏∞ ÏúÑÌï¥ÏÑú ÏÇ¨Ïö©.
        VueÏóêÏÑúÎäî v-modelÍ≥º ÎèôÏùºÌïú ÎèôÏûëÏúºÎ°ú ÏàòÌñâÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Îç∞Ïù¥ÌÑ∞ Í∞ÑÏùò ÏñëÎ∞©Ìñ• Î∞îÏù∏Îî©ÏùÑ ÏÑ§Ï†ïÌïòÎäî Ïó≠Ìï†ÏùÑ Ìï®.
        v-modelÏùÑ ÏÇ¨Ïö©ÌñàÏßÄÎßå Ï∂îÍ∞ÄÏ†ÅÏù∏ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨(Í≥µÎ∞± Ï†úÍ±∞, Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨)Í∞Ä ÌïÑÏöîÌï† Îïå Ïú†Ïö©.
      -->
      <button 
        class="text-xs basis-1/6" 
        :disabled="!newMessage.trim()"
        :class="newMessage ? 'bg-[#f7e330] hover:bg-[#ffd966]' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
        @click="sendmessage">Ï†ÑÏÜ°</button>
    </div>
  </div>
</template>

<script>
import { mapState } from 'vuex'
import { v4 as uuidv4 } from 'uuid';
import { chatformatTime } from '@/utils/chatformatTime';
import ChatTopBar from './ChatTopBar.vue';
import socket from "../utils/socket";
import axios from 'axios';

export default {
  components: {
    ChatTopBar
  },
  data() {
    return {
      newMessage: '',
      messages: [],
      chatId: null,
      readindicator: [],  // Í∞Å Î©îÏÑ∏ÏßÄÏùò ÏùΩÏùå ÏÉÅÌÉúÎ•º Ï†ÄÏû•. {Î©îÏÑ∏ÏßÄ ÏïÑÏù¥Îîî: true or false}
      userinroom: [],  // Ï±ÑÌåÖÎ∞©Ïóê Îì§Ïñ¥ÏôÄÏûàÎäî ÏÇ¨Ïö©ÏûêÎì§ ÏïÑÏù¥Îîî
      isrealtime: null  // ÏßÄÍ∏à Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÎåÄÌôîÏ§ëÏù∏ÏßÄ ÏïÑÎãåÏßÄ
    }
  },
  created() {
    this.loadUserandMessages();
  },
  props: { 
    friendId: {
      type: String,
      required: true
    },
    friendName: {
      type: String,
      required: true
    },
    friendImage: {
      type: String,
      required: false
    }
  },
  computed: {
    ...mapState(['user'])
  },
  mounted() {
    socket.on("new_message", (data) => {
      console.log("üì© ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Ïã§ÏãúÍ∞Ñ Î©îÏãúÏßÄ:", data);
      console.log("üöÄ ÏÉà Î©îÏãúÏßÄÍ∞Ä Í∞êÏßÄÎê®! `get_messages` Ïã§Ìñâ");
      socket.emit("get_messages", { chat_id: this.chatId });
    })

    // ‚úÖ ÏÑúÎ≤ÑÏóêÏÑú Ï±ÑÌåÖ ÎÇ¥Ïó≠ ÏàòÏã†
    socket.on("get_message", (data) => {
      console.log('Ï±ÑÌåÖ ÏïÑÏù¥Îîî', this.chatId);
      console.log('Î©îÏÑ∏ÏßÄÎì§222222', data);
      if (!data || data.length === 0) {
        console.error("‚ùå Î©îÏãúÏßÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏùå!", data);
        return;
      }
      this.messages = [];
      data.forEach(msg => this.addMessageToChat(msg));
    });

    socket.on("set_is_read_true", (data) => {
      console.log("üì¢ ÏùΩÏùå ÌëúÏãú ÏÜåÏºì Ïù¥Î≤§Ìä∏ Îç∞Ïù¥ÌÑ∞", data);

      // ‚úÖ Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î•º Ïù¥Ïö©Ìï¥ ÌòÑÏû¨ Î©îÏãúÏßÄÏùò ÏùΩÏùå ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      data.messages.forEach((updatedMsg) => {
        this.readindicator[updatedMsg.message_id] = updatedMsg.is_read
      });
    });

    socket.on('handle_join_room', (data) => {
      console.log("Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞:", data);

      // Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï±ÑÌåÖÎ∞© ID Í∞ÄÏ†∏Ïò§Í∏∞
      const key = Object.keys(data)[0];
      const userList = data[key] || [];

      if (!this.userinroom) {
        this.userinroom = {};
      }
      // this.userinroomÏù¥ Í∞ùÏ≤¥Í∞Ä ÏïÑÎãê Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
      if (!this.userinroom[key]) {
        this.userinroom[key] = [];
      }

      // Í∏∞Ï°¥ Î™©Î°ù Ïú†ÏßÄÌïòÎ©¥ÏÑú ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä(Ï§ëÎ≥µ Ï†úÍ±∞)
      const currentUsers = new Set(this.userinroom[key]);  // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê Î™©Î°ù
      userList.forEach(user => currentUsers.add(user));  // ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä

      this.userinroom[key] = [...currentUsers];  // SetÏùÑ Îã§Ïãú Î∞∞Ïó¥Î°ú Î≥ÄÌôò
      console.log("ÌòÑÏû¨ Ï±ÑÌåÖÎ∞© ÏÇ¨Ïö©Ïûê Î™©Î°ù:", this.userinroom[key]);

      // Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ Ïó¨Î∂Ä ÌôïÏù∏
      if (
        this.userinroom[key].includes(Number(this.friendId)) &&
        this.userinroom[key].includes(Number(this.user.userid))
      ) {
        this.isrealtime = true;
        console.log("Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖÏ§ë?", this.isrealtime);
      } else {
        this.isrealtime = false;
      }
    });

    socket.on('handle_leave_room', (data) => {
      console.log('Ï±ÑÌåÖÎ∞© ÎÇòÍ∞Ñ ÌõÑ', data);

      const key = Object.keys(data)[0];
      const userList = data[key] || [];
      
      if (this.userinroom[key]) {
        // ÎÇòÍ∞Ñ ÏÇ¨Îûå Ìï¥Îãπ Ï±ÑÌåÖÎ∞©ÏóêÏÑú ÏÇ≠Ï†ú
        this.userinroom[key] = this.userinroom[key].filter(id => id !== userList);
        
        // ÎßåÏïΩ Î∞©Ïóê ÏïÑÎ¨¥ÎèÑ ÏóÜÏúºÎ©¥ Ìï¥Îãπ ÌÇ§ ÏÇ≠Ï†ú
        if (this.userinroom[key].length === 0) {
          delete this.userinroom[key];
        }
      }
      this.isrealtime = false
    })
  },
  updated() {
    this.scrollToBottom();
  },
  methods: {
    async loadUserandMessages() {
      await this.$store.dispatch('fetchUserData'); 

      if (this.user && this.user.userid) {
        this.chatId = this.getChatId();
        socket.emit("get_messages", { chat_id: this.chatId }); // ‚úÖ ÏÑúÎ≤ÑÏóê Î©îÏãúÏßÄ ÏöîÏ≤≠
      } else {
        console.error('User is not defined or userid is missing');
      }

      this.setIsReadTrue(this.chatId);
    },
    getChatId() {
      const ids = [this.user.userid, this.friendId].sort();
      const chatKey = `chatId_${ids.join('_')}`;  
      let chatId = localStorage.getItem(chatKey); 

      if (!chatId) {  
        chatId = uuidv4();   
        localStorage.setItem(chatKey, chatId); 
      }
      return chatId;
    },
    scrollToBottom() {
      const container = this.$refs.chatContainer;
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    },
    sendmessage() {
      if (this.newMessage.trim()) {
        const timestamp = new Date().toISOString();
        const tempId = `temp-${Date.now()}`;

        const message = {
          id: tempId,
          chat_id: this.chatId,
          sender_id: this.user.userid,
          sender_name: this.user.username,
          receiver_id: this.friendId,
          receiver_name: this.friendName,
          text: this.newMessage,
          created_at: timestamp,
          realtime: this.isrealtime
        };

        console.log('Î≥¥ÎÇº Î©îÏÑ∏ÏßÄ', message);

         // ‚úÖ ÎÇ¥Í∞Ä Î≥¥ÎÇ∏ Î©îÏãúÏßÄÎ•º ÌôîÎ©¥Ïóê Ï¶âÏãú Ï∂îÍ∞Ä
        this.addMessageToChat(message);

         // ‚úÖ ÏÑúÎ≤ÑÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ°
        socket.emit("message", message);
        socket.emit("get_messages", { chat_id: this.chatId });
          
        this.newMessage = '';  // Î©îÏÑ∏ÏßÄ Î≥¥ÎÇ¥Í≥† input ÎπÑÏö∞Í∏∞
      }
    },
    addMessageToChat(data) {
      // ÎÇ†Ïßú ÌÇ§ÏôÄ ÏöîÏùº Í≥ÑÏÇ∞
      const daysOfWeek = ["ÏùºÏöîÏùº", "ÏõîÏöîÏùº", "ÌôîÏöîÏùº", "ÏàòÏöîÏùº", "Î™©ÏöîÏùº", "Í∏àÏöîÏùº", "ÌÜ†ÏöîÏùº"];
      const dateObj = new Date(data.created_at);
      const year = dateObj.getFullYear();
      const month = dateObj.getMonth() + 1;
      const day = dateObj.getDate();
      const dateKey = `${year}ÎÖÑ ${month}Ïõî ${day}Ïùº`;
      const dayOfWeek = daysOfWeek[dateObj.getDay()];

      // ÏãúÍ∞Ñ + Î∂Ñ ÌÇ§ ÏÉùÏÑ±
      const hour = dateObj.getHours().toString().padStart(2, "0");
      const minute = dateObj.getMinutes().toString().padStart(2, "0");
      const minuteKey = `${hour}:${minute}`;

      // ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄ Ìè¨Îß∑
      const formattedMessage = {
        ...data,
        created_at: chatformatTime(data.created_at)
      };
      
      const senderId = formattedMessage.sender_id;
      // Í∏∞Ï°¥ Í∑∏Î£πÏóêÏÑú Î©îÏãúÏßÄÎ•º Ï∂îÍ∞ÄÌï† Ìï¥Îãπ ÎÇ†Ïßú ÌÇ§Î•º Ï∞æÏùå
      const groupIndex = this.messages.findIndex(group => group.date === dateKey);

      if (groupIndex !== -1) {
        // Ìï¥Îãπ ÎÇ†Ïßú Í∑∏Î£πÏù¥ Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Í∑∏ Í∑∏Î£πÏùò groupedMinutes(ÏãúÍ∞Ñ Í∑∏Î£π) Î∞∞Ïó¥ÏùÑ groupedMinutesÏóê Ï†ÄÏû•
        const groupedMinutes = this.messages[groupIndex].groupedMinutes;

        if (!groupedMinutes[minuteKey]) {
          // Ìï¥Îãπ ÎÇ†ÏßúÎäî ÏûàÎäîÎç∞ Ìï¥Îãπ ÏãúÍ∞ÑÏù¥ ÏóÜÏùÑ Í≤ΩÏö∞ ÏÉàÎ°ú ÏÉùÏÑ±
          groupedMinutes[minuteKey] = {};
        }

        // Ìï¥Îãπ sender_id Í∑∏Î£πÏù¥ ÏóÜÏúºÎ©¥ ÏÉàÎ°ú ÏÉùÏÑ±
        if (!groupedMinutes[minuteKey][senderId]) {
          groupedMinutes[minuteKey][senderId] = [];
        }

        // Ìï¥Îãπ sender_id Í∑∏Î£πÏóê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        groupedMinutes[minuteKey][senderId].push(formattedMessage);
      } else {
        // Ìï¥Îãπ ÎÇ†Ïßú Í∑∏Î£πÏù¥ ÏóÜÏúºÎ©¥ ÏÉà Í∑∏Î£πÏùÑ ÏÉùÏÑ± ÌõÑ Î©îÏÑ∏ÏßÄ Ï∂îÍ∞Ä
        this.messages.push({
          date: dateKey,
          day: dayOfWeek,
          groupedMinutes: {
            [minuteKey]: {
              [senderId]: [formattedMessage]
            }
          }
        });
      }

      // Ï∂îÍ∞ÄÎêú Î©îÏÑ∏ÏßÄÎ•º ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
      this.sortMessages();
      this.$nextTick(() => this.scrollToBottom());  // Ïä§ÌÅ¨Î°§ ÏûêÎèô Ïù¥Îèô
    },
    sortMessages() {
      // ÏãúÍ∞Ñ -> ÏïÑÏù¥ÎîîÎ≥ÑÎ°ú Í∑∏Î£πÎêòÏñ¥ÏûàÎäî Î©îÏÑ∏ÏßÄÎì§ÏùÑ Îã§Ïãú ÌïòÎÇòÎ°ú Ìï©Ï≥êÏÑú ÏãúÍ∞ÑÏàúÏÑúÎåÄÎ°ú Ï†ïÎ†¨
      // Ïù¥Î†áÍ≤å ÏïàÌïòÎ©¥ Í∞ÅÏûê ÏïÑÏù¥ÎîîÎ∞ëÏóê Ï∂îÍ∞ÄÎêòÍ∏∞ ÎïåÎ¨∏Ïóê ÎåÄÌôîÍ∞Ä ÏïàÎêòÍ≥† Í±∞Ïùò ÎèÖÎ∞±Ïù¥ Îê®„Ö†
      this.messages.forEach(group => {
        group.groupedMinutes = Object.fromEntries(
          Object.entries(group.groupedMinutes).map(([minuteKey, senderGroups]) => [
            minuteKey,
            Object.values(senderGroups)  // sender_id Î≥Ñ Î©îÏãúÏßÄ Î∞∞Ïó¥Îì§ Í∞ÄÏ†∏Ïò§Í∏∞
              .flat() // ÌïòÎÇòÏùò Î∞∞Ïó¥Î°ú Ìï©ÏπòÍ∏∞
              .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))  // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
          ])
        )
      })
    },
    isFirstAfterReply(msgGroup, msgIndex, minuteGroup) {
      // msgGroup ÎÇ¥ÏóêÏÑú Ï≤´Î≤àÏß∏ Î©îÏãúÏßÄÏù¥Í±∞ÎÇò, Ï§ëÍ∞ÑÏóê ÏÉÅÎåÄÎ∞©Ïù¥ ÎãµÏû•ÏùÑ Ìï¥ÏÑú ÏãúÍ∞ÑÏùÄ ÏïàÏßÄÎÇ¨ÏßÄÎßå Îã§Ïãú Î≥¥Ïó¨Ï§òÏïºÌï† ÎïåÎäî true Î∞òÌôò
      if (msgIndex === 0) return true; // ÏõêÎûò Ï≤´ Î≤àÏß∏ Î©îÏãúÏßÄÎäî Î¨¥Ï°∞Í±¥ ÌëúÏãú

      const prevMsg = minuteGroup[msgIndex - 1]; // Ïù¥Ï†Ñ Î©îÏãúÏßÄ
      return prevMsg && prevMsg.sender_id !== msgGroup[msgIndex].sender_id;
    },
    isLastMessageInSenderGroup(msgGroup, msgIndex, minuteGroup) {
      // msgGroupÏóêÏÑú ÎßàÏßÄÎßâ Î©îÏÑ∏ÏßÄÏù¥Í±∞ÎÇò Îã§Ïùå Î©îÏãúÏßÄÍ∞Ä Îã§Î•∏ senderÎùºÎ©¥ true Î∞òÌôò
      // ÏãúÍ∞ÑÏù¥ ÎßàÏßÄÎßâ Î©îÏÑ∏ÏßÄÏóêÎßå ÌëúÏãúÎêòÎèÑÎ°ù Ìï¥ÎíÄÎäîÎç∞ ÏÉÅÎåÄÎ∞©Ïù¥ Í∞ôÏùÄ ÏãúÍ∞Ñ ÏïàÏóê ÎãµÏû•Ìï®ÎÖÄ Í∑∏ Î©îÏÑ∏ÏßÄÍ∞Ä ÎßàÏßÄÎßâÏù¥ ÎêòÎ©¥ÏÑú ÏãúÍ∞ÑÏùÑ Î∫èÏñ¥Í∞ê„Ö†
      if (msgIndex === msgGroup.length - 1) return true; // Í∑∏Î£π ÎÇ¥ ÎßàÏßÄÎßâ Î©îÏãúÏßÄÎäî Î¨¥Ï°∞Í±¥ true

        const nextMsg = minuteGroup[msgIndex + 1]; // Îã§Ïùå Î©îÏãúÏßÄ
        return !nextMsg || nextMsg.sender_id !== msgGroup[msgIndex].sender_id;
    },
    updateMessageInChat(data) {
      console.log("üì© ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Î©îÏãúÏßÄÎ•º Í∏∞Ï°¥ Î©îÏãúÏßÄÏôÄ ÎπÑÍµêÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏:", data);

      for (let group of this.messages) {
        for (let minuteKey in group.groupedMinutes) {
          let minuteGroup = group.groupedMinutes[minuteKey];
          const index = minuteGroup.findIndex(msg => msg.id === `temp-${data.created_at}`);

          if (index !== -1) {
            minuteGroup[index] = data; // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏
            return;
          }
        }
      }
      this.addMessageToChat(data);
    },
    async unreadmessages() {
      if (!this.user || !this.user.userid) return;
      socket.emit("get_unread_message", { user_id: this.user.userid });
      // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú ÏÑúÎ≤ÑÏóê "ÎÇò Ïïà ÏùΩÏùÄ Î©îÏÑ∏ÏßÄ Í∞úÏàò Ï¢Ä ÏïåÎ†§Ï£ºÎùº"ÎùºÍ≥† emitÏúºÎ°ú ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥Í≤å ÎêòÍ≥† ÏÑúÎ≤ÑÏùò @socketio.on("get_unread_message")ÎùºÏö∞Ìä∏Í∞Ä Ïã§ÌñâÎê®. get_unread_message ÎùºÏö∞Ìä∏ ÎÇ¥ÏóêÏÑú Ïïà ÏùΩÏùÄ Î©îÏãúÏßÄÎ•º Ï°∞Ìöå ÌõÑ Îã§Ïãú emit("get_unread_message", result)Î•º Ïã§ÌñâÌïòÍ≤å ÎêòÎ©¥ Îã§Ïãú ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú(MainBar)Ïùò socket.on("get_unread_message")Í∞Ä ÏûêÎèô Ïã§ÌñâÎêòÎ©¥ÏÑú ÏàòÏã†Ìï®
    },
    async setIsReadTrue(chatid) {
      try {
        // this.chatIdÎûë this.userid
        //  {{ this.chatId }}{{ this.user.userid }}
        console.log('ÏÑúÎ≤ÑÏóê ÏùΩÏùå Ï≤òÎ¶¨ Ïù¥Î≤§Ìä∏ ÏöîÏ≤≠');
        socket.emit("set_is_read_true", { chat_id: chatid, userid: this.user.userid })

        const response = await axios.post(`http://localhost:5000/setisreadtrue/${chatid}`, {
          userid: this.user.userid
        });
        console.log('is_readÎ•º trueÎ°ú', response.data);
        
        // ÌäπÏ†ï Ï±ÑÌåÖÎ∞©Îßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎèÑÎ°ù Vuex ÏÉÅÌÉú Î≥ÄÍ≤Ω
        this.$store.commit("set_specific_unread_message", {
          chatid: chatid, 
          userid: this.user.userid
        });

        // ‚úÖ ÏÑúÎ≤ÑÏóêÏÑú ÏµúÏã† unread Í∞úÏàò Í∞ÄÏ†∏Ïò§Í∏∞
        this.unreadmessages();

      } catch (error) {
        console.error('Error setting is_read:', error.response.data);
      }
    }
  }
}
</script>

<style>
#app {
  display: flex;
  flex-direction: column;
  height: 100vh; /* ÌôîÎ©¥ Ï†ÑÏ≤¥Î•º Ï±ÑÏõÄ */
}

.chat-container {
  height: 500px;
  flex: 1;
  overflow-y: auto;
  background: #bad0e5;
  padding: 10px;
}

.sender-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-end;  /* Î©îÏÑ∏ÏßÄ Ïò§Î•∏Ï™Ω Ï†ïÎ†¨*/
  position: relative;
}

.receiver-wrapper {
  display: flex;
  flex-direction: column;
  position: relative;
}

.message-container {
  display: flex;
  flex-direction: row;
  align-items: flex-end;  /* ÏãúÍ∞ÑÏù¥Îûë ÎßêÌíçÏÑ† ÏàòÏßÅ Ï†ïÎ†¨ */
  max-width: 70%;
  margin-bottom: 6px;
}

.sender {
  background-color: #f7e330; 
  border-radius: 4px;
  padding: 6px 10px;
  font-size: 12px;
  position: relative;
  word-break: break-word;
  text-align: left;
}


.receiver {
  background-color: white;
  border-radius: 4px;
  padding: 6px 10px;
  position: relative;
  margin-right: 7px; 
  font-size: 12px;
}

.info-wrapper {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 1px;
  margin-top: 2px;
  padding-right: 2px;
}

.receiver-wrapper .time {
  color: #555555;
  font-size: 11px;
  padding-top: 14px;
}
.sender-wrapper .time {
  color: #555555;
  font-size: 11px;
  width: 50px;
  margin-top: 12px;
}


/* ÏùΩÏßÄ ÏïäÏùÄ Î©îÏãúÏßÄ (1)Î•º ÏãúÍ∞Ñ ÏúÑÏóê ÏûëÏùÄ ÌÅ¨Í∏∞Î°ú ÌëúÏãú */
.sender-wrapper .unread-indicator {
  font-size: 11px;
  color: #f7e330;
  text-align: center;
  padding-right: 3px;

}

.abc .time {
  margin-top: -5px;
}


.sender.has-tail::after,
.receiver.has-tail::after {
  content: '';
  position: absolute;
  width: 0;
  height: 0;
}

.sender.has-tail::after {
  border-left: 13px solid #f7e330;
  border-top: 2px solid transparent;
  border-bottom: 10px solid transparent;
  right: -10px; 
  top: 8px;
}

.receiver.has-tail::after {
  border-right: 13px solid white;
  border-top: 2px solid transparent;
  border-bottom: 10px solid transparent;
  left: -10px;
  top: 8px;
}

/* Ïä§ÌÅ¨Î°§Î∞î Ï†ÑÏ≤¥ ÏòÅÏó≠ */
::-webkit-scrollbar {
  width: 10px; /* ÏÑ∏Î°ú Ïä§ÌÅ¨Î°§Î∞î ÎÑàÎπÑ */
  height: 10px; /* Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§Î∞î ÎÜíÏù¥ */
}

/* Ïä§ÌÅ¨Î°§Î∞î Ïä¨ÎùºÏù¥Îçî */
::-webkit-scrollbar-thumb {
  background: #a8a8a8; /* Ïä¨ÎùºÏù¥Îçî ÏÉâÏÉÅ */
  border-radius: 10px; /* Îë•Í∑º Î™®ÏÑúÎ¶¨ */
}

/* Ïä¨ÎùºÏù¥ÎçîÏóê ÎßàÏö∞Ïä§Î•º Ïò¨Î†∏ÏùÑ Îïå */
::-webkit-scrollbar-thumb:hover {
  background: #555; /* Ìò∏Î≤Ñ Ïãú ÏÉâÏÉÅ */
}


</style>